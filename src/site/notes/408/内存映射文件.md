---
{"dg-publish":true,"dg-permalink":"/408/内存映射文件","permalink":"/408/内存映射文件/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true}
---

## 内存映射文件（Memory-Mapped File）

### 1. 概念
**内存映射文件**是一种将文件内容直接映射到进程虚拟地址空间的技术。通过这种方式，文件不再像传统 I/O 那样需要通过 `read()`/`write()` 等系统调用进行显式的数据传输，而是可以直接像访问内存一样访问文件内容。

当一个文件被内存映射时，操作系统会：

1. 在进程的虚拟地址空间中开辟一块区域。
    
2. 将这块虚拟地址区域与磁盘上的文件（或文件的一部分）建立关联。
    
3. 当进程访问这块虚拟内存区域时，实际访问的就是文件中的数据。


### 2. 它为了实现什么作用？（主要目的）
内存映射文件主要为了实现以下作用：

- **简化文件 I/O 操作**：
    
    - **告别繁琐的 `read()`/`write()`**：程序员不再需要显式地调用 `read()` 或 `write()` 系统调用来从文件读写数据。直接对内存区域进行指针操作即可。
        
    - **消除数据拷贝**：传统的 I/O 操作通常涉及两次数据拷贝：一次是从磁盘缓存到内核缓冲区，另一次是从内核缓冲区到用户缓冲区。内存映射文件通过将文件数据直接映射到用户进程的虚拟地址空间，**消除了至少一次（通常是两次）不必要的数据拷贝**，从而显著提高了 I/O 效率。
        
- **实现高效的进程间通信（IPC）**：
    
    - 如果多个进程将同一个文件映射到各自的虚拟地址空间，那么它们就可以通过修改这块共享内存区域来实时地进行数据交换。
        
    - 这提供了一种比管道、消息队列等更高效的 IPC 方式，因为它避免了数据在内核和用户空间之间的反复拷贝。
        
- **支持大文件处理**：
    
    - 即使文件大小超过了物理内存容量，内存映射文件也能有效处理。操作系统会按需加载文件页面（类似于请求分页），只有当实际访问到某个内存区域时，对应的文件数据才会被从磁盘加载到物理内存中。这允许应用程序处理比可用 RAM 大得多的文件。
        
- **简化代码逻辑**：
    
    - 将文件视为内存区域，可以像操作数组或指针一样操作文件内容，简化了许多复杂的文件处理逻辑，特别是对于随机访问文件。


### 3. 存在意义是什么？
内存映射文件的存在意义在于它提供了一种**高性能、高效率、且更为自然**的文件 I/O 和 IPC 机制，解决了传统 I/O 模式的一些痛点：

- **性能优化**：通过减少系统调用和数据拷贝，极大地提升了大文件读写和随机访问的性能。
    
- **资源利用率提升**：操作系统可以更智能地管理内存和磁盘I/O。例如，如果多个进程映射同一个文件，它们可以共享物理内存中的文件页面，节约了内存资源。脏页（被修改的页面）可以延迟写回磁盘，操作系统可以优化写回时机。
    
- **编程模型简化**：从面向“文件句柄+读写偏移”的编程模型转变为面向“内存指针+偏移”的编程模型，更符合C/C++等语言的习惯。
    
- **为虚拟内存提供更广泛的应用**：将虚拟内存技术从程序代码和数据扩展到了文件内容，使得文件可以作为虚拟内存的后备存储。


### 4. 和文件系统的联系是什么？
内存映射文件与文件系统有着**本质的、不可分割的联系**：

1. **文件是基础**：内存映射的底层对象始终是文件系统中的一个文件。没有文件系统，就没有文件，也就无法进行内存映射。
    
2. **文件系统提供结构化存储**：文件系统负责将文件数据逻辑地组织在磁盘上，并提供文件名、目录结构、权限等元数据。内存映射需要这些信息来定位磁盘上的文件数据。
    
3. **文件系统管理数据块**：当进程访问映射区域的某个虚拟页面时，如果该页面不在物理内存中（缺页），操作系统会通知文件系统，由文件系统负责将对应的文件数据块从磁盘加载到物理内存中。同样，当修改后的页面需要写回磁盘时（脏页回写），也是由文件系统负责将数据写回到文件对应的磁盘块。
    
4. **一致性维护**：当文件被内存映射并修改时，操作系统（通过文件系统）需要确保内存中的修改最终会被同步回磁盘上的文件，以保持数据的一致性。
    
5. **权限管理**：内存映射文件的访问权限（读/写/执行）直接继承自底层文件的权限，并通过文件系统的权限检查机制进行管理。
    
6. **持久化存储**：内存映射文件的修改最终会通过文件系统写回到磁盘，实现数据的持久化存储，这是与纯粹的共享内存（如 `shm_open` 或 `mmap` `MAP_ANONYMOUS`）的关键区别，后者通常不与永久文件关联。
    

简而言之，**内存映射文件是操作系统虚拟内存机制与文件系统I/O机制的深度融合**。它将文件系统中的持久化数据，通过虚拟内存技术，“投影”到进程的地址空间中，从而实现高效的访问和管理。


### 总结图示：
```
+-------------------------------------------------+
|               用户进程虚拟地址空间             |
|                                                 |
| +---------------------------------------------+ |
| |  ...                                      | |
| |  [虚拟内存区域] <-- 内存映射文件区域        | |
| |  (例如: 从虚拟地址 0x80000000 开始)         | |
| |  (访问这块区域就像访问内存数组一样)         | |
| +---------------------------------------------+ |
|  ...                                          |
+-------------------------------------------------+
          |                               ^
          | (缺页中断/写回请求)         | (数据从磁盘加载)
          V                               |
+-------------------------------------------------+
|               操作系统内核                 |
|                                                 |
| +---------------------------------------------+ |
| |   内存管理单元 (MMU)                       | |
| |   (处理虚拟地址到物理地址转换)           | |
| |                                             | |
| |   页面置换算法 (当物理内存不足时)          | |
| |                                             | |
| |   文件系统 (负责文件查找、分配、读写)      | |
| |   (通过 FCB/i-node 定位文件数据块)         | |
| +---------------------------------------------+ |
          |                               ^
          | (物理 I/O 请求)             | (磁盘数据)
          V                               |
+-------------------------------------------------+
|                 物理内存 (RAM)                 |
|                                                 |
| +---------------------------------------------+ |
| |  文件数据页面 (通过映射加载到这里)        | |
| +---------------------------------------------+ |
          |                               ^
          | (物理块访问)                  | (数据从磁盘)
          V                               |
+-------------------------------------------------+
|              磁盘 (文件系统存储)               |
|                                                 |
| +---------------------------------------------+ |
| |  文件数据块 (存储在文件系统的特定位置)      | |
| |  (由 FCB/i-node 维护其物理地址)             | |
| +---------------------------------------------+ |
+-------------------------------------------------+
```

**如上图，文件经过内存映射后，对文件对应地址的访问就不再需要通过 read()/write()**
**系统调用，而是可以直接访问对应的虚拟内存，通过 MMU 映射和缺页异常处理来访问到对**
**应磁盘中的文件信息。**

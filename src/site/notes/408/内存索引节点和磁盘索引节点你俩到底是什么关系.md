---
{"dg-publish":true,"dg-permalink":"/408/内存索引节点和磁盘索引节点你俩到底是什么关系","permalink":"/408/内存索引节点和磁盘索引节点你俩到底是什么关系/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true}
---

### **1. 为什么会有“内存中的索引节点”？**

首先，我们要明白索引节点（在UNIX/Linux中称为**i-node**，在一些教材中也泛称为**文件控制块FCB**）是存储在**磁盘**上的。它记录了文件的所有属性，如大小、权限、时间戳、以及指向数据块的指针等。

- **读入内存**: 当一个文件被第一次`open()`时，操作系统会找到磁盘上对应的i-node，并将其**读入到内核的内存**中，形成一个“内存i-node副本”。
    
- **性能优化**: 之后，所有对该文件的操作，都是直接针对这个**内存i-node**进行的。因为访问内存的速度比访问磁盘快成千上万倍。如果每次操作都去读写磁盘上的i-node，系统性能将无法忍受。
    

### **2. 哪些操作会改变“内存i-node”？**

只要文件的元数据发生变化，内存i-node就会被修改。例如：

- **`write()`操作**:
    
    - 如果写入导致文件变大，内存i-node中的`i_size`（文件大小）字段会被更新。
        
    - 如果需要分配新的数据块，内存i-node中的数据块指针列表会被更新。
        
    - `i_mtime`（最后修改时间）会被更新。
        
- **`read()`操作**:
    
    - `i_atime`（最后访问时间）会被更新。
        
- **修改权限或所有者 (`chmod`, `chown`)**:
    
    - 对应的权限位或用户/组ID字段会被更新。
        

在这些操作发生后，内存中的i-node就已经和磁盘上的原始i-node不一致了。此时，内核会将这个内存i-node标记为**“脏”(Dirty)**，表示它“已被修改，需要写回磁盘”。

### **3. 什么时候“内存i-node”会被写回到“磁盘i-node”？**

这正是你问题的关键。操作系统不会在每次修改后都立即写回，而是会在以下几种关键时机，将“脏”的内存i-node同步到磁盘：

1. **文件正常关闭时 (`close()`)**:
    
    - 这是最常见和最重要的时机。我们之前讨论过，`close()`操作的一个核心职责就是确保数据和元数据的一致性。在关闭文件时，内核会检查其内存i-node是否为“脏”。如果是，就会将其内容**写回到磁盘上对应的i-node**中。
        
2. **内核定期同步**:
    
    - 现代操作系统（如Linux）中有名为`sync`、`bdflush`或`kupdated`的后台守护进程。它们会周期性地（例如每隔5秒或30秒）被唤醒，然后将在内存中所有“脏”的缓冲区数据和“脏”的i-node**批量地写回到磁盘**。这保证了即使系统长时间不关机，数据的安全性也能得到阶段性的保障。
        
3. **用户或管理员强制同步**:
    
    - 在Linux/UNIX系统中，执行`sync`命令会强制内核立即将所有脏数据和脏i-node写回磁盘。这在重要操作后或关机前非常有用。
        
4. **应用程序主动请求同步 (`fsync()`)**:
    
    - 对于需要极高可靠性的程序（如数据库），它可以调用`fsync()`系统调用。这个调用会强制将**指定文件**的脏数据和脏i-node**立即、同步地**写回磁盘，并等待磁盘操作完成后才返回。这为应用程序提供了更精细的控制。
        
5. **内存不足时**:
    
    - 当系统内存紧张，需要回收内存页面时，如果一个“脏”的内存i-node所在的内存页被选中换出，系统也会先将其内容写回磁盘。
        

---

### **一个生动的比喻**

- **磁盘上的i-node**: 你保存在硬盘里的一个Word文档 (`MyReport.docx`)。
    
- **内存中的i-node**: 你双击打开`MyReport.docx`后，在Word程序里正在编辑的文档内容。
    
- **文件操作**: 你在Word里打字、修改格式。所有的这些修改都**立即**体现在你屏幕上看到的、内存里的这份文档中。但此时，你硬盘上的那个`.docx`文件**还没有发生任何改变**。
    
- **写回磁盘**: 你点击**“保存”**按钮（相当于`fsync()`或`close()`），或者Word的自动保存功能启动（相当于内核定期同步）。这时，你在内存中所有的修改才会被一次性地写入到硬盘的`.docx`文件中，覆盖掉旧的版本。
    
